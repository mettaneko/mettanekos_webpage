class CompactMusicPlayer {
    constructor() {
        this.player = document.getElementById('compactPlayer');
        this.closeBtn = document.getElementById('compactCloseBtn');
        this.playPauseBtn = document.getElementById('compactPlayPauseBtn');
        this.volumeBtn = document.getElementById('compactVolumeBtn');
        this.progressBar = document.getElementById('compactProgressBar');
        this.progress = document.getElementById('compactProgress');
        this.currentTimeEl = document.getElementById('compactCurrentTime');
        this.durationEl = document.getElementById('compactDuration');
        
        this.playIcon = this.playPauseBtn.querySelector('.play-icon');
        this.pauseIcon = this.playPauseBtn.querySelector('.pause-icon');
        this.volumeOnIcon = this.volumeBtn.querySelector('.volume-on-icon');
        this.volumeOffIcon = this.volumeBtn.querySelector('.volume-off-icon');
        
        this.isPlaying = false;
        this.currentTrack = null;
        this.demoInterval = null;
        this.isMuted = false;
        
        this.init();
    }
    
    init() {
        this.closeBtn.addEventListener('click', () => this.close());
        this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
        this.volumeBtn.addEventListener('click', () => this.toggleMute());
        this.progressBar.addEventListener('click', (e) => this.setProgress(e));
        
        console.log('üéµ Compact player initialized - Visual Demo Mode');
    }
    
    open(trackInfo) {
        console.log('üéµ Opening player with track:', trackInfo);
        
        this.currentTrack = trackInfo;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–∫–µ
        document.getElementById('compactTrackName').textContent = trackInfo.name;
        document.getElementById('compactArtistName').textContent = trackInfo.artist;
        document.getElementById('compactAlbumCover').src = trackInfo.albumCover;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        this.stopAudio();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º
        this.setupDemoMode();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
        this.player.classList.remove('hiding');
        this.player.classList.add('active');
        
        this.showNotification('üéµ –î–µ–º–æ-—Ä–µ–∂–∏–º. –ù–∞–∂–º–∏ Play –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
    }
    
    stopAudio() {
        console.log('‚èπÔ∏è Stopping audio playback');
        this.pause();
        this.stopDemoProgress();
        this.demoCurrentTime = 0;
    }
    
    setupDemoMode() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞ –æ—Ç 2 –¥–æ 4 –º–∏–Ω—É—Ç
        this.demoDuration = Math.floor(Math.random() * 120) + 120; // 2-4 –º–∏–Ω—É—Ç—ã
        this.demoCurrentTime = 0;
        this.durationEl.textContent = this.formatTime(this.demoDuration);
        this.currentTimeEl.textContent = '0:00';
        this.progress.style.width = '0%';
        
        console.log(`‚è±Ô∏è Demo track duration: ${this.formatTime(this.demoDuration)}`);
    }
    
    togglePlayPause() {
        if (this.isPlaying) {
            this.pause();
        } else {
            this.play();
        }
    }
    
    play() {
        console.log('‚ñ∂Ô∏è Starting playback');
        this.isPlaying = true;
        this.updatePlayButton();
        this.startDemoProgress();
        this.showNotification('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
    }
    
    pause() {
        if (this.isPlaying) {
            console.log('‚è∏Ô∏è Pausing playback');
            this.stopDemoProgress();
            this.isPlaying = false;
            this.updatePlayButton();
            this.showNotification('‚è∏Ô∏è –ü–∞—É–∑–∞');
        }
    }
    
    startDemoProgress() {
        this.stopDemoProgress();
        
        this.demoInterval = setInterval(() => {
            if (this.demoCurrentTime < this.demoDuration) {
                this.demoCurrentTime++;
                this.updateDemoProgress();
                
                // –°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ - "–±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è"
                if (Math.random() < 0.01) { // 1% chance
                    this.simulateBuffering();
                }
            } else {
                this.onTrackEnd();
            }
        }, 1000);
    }
    
    simulateBuffering() {
        console.log('üì• Simulating buffering...');
        this.showNotification('üì• –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è...');
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
        this.stopDemoProgress();
        setTimeout(() => {
            if (this.isPlaying) {
                this.startDemoProgress();
                this.showNotification('‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }
        }, 2000);
    }
    
    stopDemoProgress() {
        if (this.demoInterval) {
            clearInterval(this.demoInterval);
            this.demoInterval = null;
        }
    }
    
    updateDemoProgress() {
        const progressPercent = (this.demoCurrentTime / this.demoDuration) * 100;
        this.progress.style.width = `${progressPercent}%`;
        this.currentTimeEl.textContent = this.formatTime(this.demoCurrentTime);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        this.durationEl.textContent = this.formatTime(this.demoDuration);
    }
    
    toggleMute() {
        this.isMuted = !this.isMuted;
        this.updateVolumeButton();
        this.showNotification(this.isMuted ? 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω' : 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω');
        console.log(this.isMuted ? 'üîá Muted' : 'üîä Unmuted');
    }
    
    setProgress(e) {
        if (!this.isPlaying) return;
        
        const rect = this.progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        
        this.demoCurrentTime = Math.floor(percent * this.demoDuration);
        this.updateDemoProgress();
        
        console.log(`‚è© Seeking to: ${this.formatTime(this.demoCurrentTime)}`);
        this.showNotification(`‚è© –ü–µ—Ä–µ–º–æ—Ç–∫–∞: ${this.formatTime(this.demoCurrentTime)}`);
    }
    
    onTrackEnd() {
        console.log('‚èπÔ∏è Track ended');
        this.isPlaying = false;
        this.updatePlayButton();
        this.stopDemoProgress();
        this.demoCurrentTime = 0;
        this.updateDemoProgress();
        
        this.showNotification('‚úÖ –¢—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        
        // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ "—Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫" —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (this.player.classList.contains('active')) {
                this.showNotification('üîÑ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫...');
                this.restartPlayback();
            }
        }, 3000);
    }
    
    restartPlayback() {
        this.stopAudio();
        this.setupDemoMode();
        this.play();
    }
    
    updatePlayButton() {
        if (this.isPlaying) {
            this.playIcon.style.display = 'none';
            this.pauseIcon.style.display = 'block';
        } else {
            this.playIcon.style.display = 'block';
            this.pauseIcon.style.display = 'none';
        }
    }
    
    updateVolumeButton() {
        if (this.isMuted) {
            this.volumeOnIcon.style.display = 'none';
            this.volumeOffIcon.style.display = 'block';
        } else {
            this.volumeOnIcon.style.display = 'block';
            this.volumeOffIcon.style.display = 'none';
        }
    }
    
    close() {
        console.log('‚ùå Closing player');
        this.player.classList.add('hiding');
        setTimeout(() => {
            this.player.classList.remove('active');
            this.stopAudio();
        }, 300);
        this.showNotification('üëã –ü–ª–µ–µ—Ä –∑–∞–∫—Ä—ã—Ç');
    }
    
    formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    showNotification(message) {
        console.log('üí¨ Player:', message);
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const oldNotification = document.querySelector('.player-notification');
        if (oldNotification) {
            oldNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = 'player-notification';
        notification.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-background);
            color: var(--text-color);
            padding: 12px 24px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 1002;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease-out;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideDown 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 3000);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    @keyframes slideDown {
        from {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        to {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
    }
`;
document.head.appendChild(style);

let compactPlayer;
document.addEventListener('DOMContentLoaded', () => {
    compactPlayer = new CompactMusicPlayer();
    window.compactPlayer = compactPlayer;
    console.log('üéµ Compact player ready - Visual Demo Mode Active');
});